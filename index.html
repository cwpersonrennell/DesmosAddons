<!doctype html>
<html lang="en-us">
  <head>
    <title>Desmos Application Builder</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Build a Desmos presentation to inject into your own site.">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script defer="" src="https://www.desmos.com/api/v1.7/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
    <script defer src="./copyToClipboard.js"></script>
    <script defer src="./DesmosAddons.js"></script>
    <script defer src="./throttle.js"></script>
    <style>
      body { max-width: 1000px; width: 100%; margin: 1em auto; font-size: 2em; }
    </style>
  </head>
  <body>
	  <h1>Desmos App Builder</h1>
	  <p>Use the Desmos app below to build your perfect graph then copy the html from the textarea and paste into your own site!</p>
	  <p>You will need to include the following in your site header to render the Desmos correctly:</p>
	  <div style="border:solid black 2px; background:black; foreground:white;">
&lt;script defer="" src="https://www.desmos.com/api/v1.7/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"&gt;&lt;/script&gt;<br>
&lt;script defer src="https://cwpersonrennell.github.io/DesmosAddons/DesmosAddons.js"&gt;&lt;/script&gt;<br>
&lt;script defer="defer"&gt;
     document.addEventListener("DOMContentLoaded", () => {getCalculators();});
&lt;/script&gt;
	  </div>
<div id="calculator" style="width:800px;height:600px">
      
    </div>
    <div>
      <form id="calculator_dimensions">
        <label for="width">Calculator Width:</label><input name="width" value="800"><br>
        <label for="height">Calculator Height:</label><input name="height" value="600">
        
      </form>
      <hr>
      <form id="calculator_options">
      </form>
      <hr>
      <input id="copy" type="button" value="Copy to Clipboard">
      <div id="feedback"></div>
	    <textarea id="text_result"></textarea>
      <div id="result"></div>
      
    </div>
  </body>
  <script>
 let DesmosOptions ={
      'expressions':true,
	  'keypad':true,
	  'graphpaper':true,
      'showGrid':true,
      'showXAxis':true,
      'showYAxis':true,
      'xAxisNumbers':true,
      'yAxisNumbers':true,
      'trace':true,
      'pointsOfInterest':true,
	 
      'settingsMenu':true,
      'zoomButtons':true,
      'expressionsCollapsed':false,
      'capExpressionSize':false,
      'lockViewport':false,
      //'showResetButtonOnGraphpaper':false,
      'projectorMode':false,
      //'fontSize':16,
      'invertedColors':false,
    }
 	let NewDesmosOnly = ["keypad","graphpaper","expressions","settingsMenu","zoomButtons", "pointsOfInterest", "lockViewport", "projectorMode", "fontSize", "expressionsCollapsed", "invertedColors"];
    let calculator;

    function save(calculator,name){
        localStorage.setItem(`calculator.${name}`,JSON.stringify(calculator.getState()));
    }
	function load(calculator,name){
		calculator.setState(JSON.parse(localStorage.getItem(`calculator.${name}`)));
	}
	  
	function getCalculatorOptions(){
        let current_state = calculator.getState();
		let options = {};
		let formEl = document.getElementById('calculator_options');
		for(key in DesmosOptions){
			options[key] = formEl[key].checked;
		}
		let state = {};
		Object.assign(state,options);
		for(key of NewDesmosOnly){
			delete state[key];
		}
        for(key in state){
          current_state[key] = state[key]
        }
		return [options,state];
	}
	  
    function rebuildCalculator(){
        let options = getCalculatorOptions()[0];      
		let el = document.getElementById('calculator');
		let calcDim= document.getElementById('calculator_dimensions');
		let newEl = document.createElement('div');
		let state = calculator.getState();
      
		newEl.id="calculator";

		newEl.setAttribute('style',`width:${calcDim.width.value}px;height:${calcDim.height.value}px`);

		el.replaceWith(newEl);

		calculator.destroy();
		calculator = Desmos.GraphingCalculator(newEl,options);
	    
		calculator.setExpressions(state.expressions.list);
      try{
        let viewport = state.graph.viewport;
        calculator.setMathBounds(
          {'left':viewport.xmin,
           'right':viewport.xmax,
          'bottom':viewport.ymin,
           'top':viewport.ymax,})
      }catch(e){}
		
        calculator.observeEvent('change',function(){
          
			throttledSave();
		});
    }
    function insertCheckbox(formEl,key,value){
      let label = document.createElement('label');
      label.innerHTML = key;
      let box = document.createElement('input');
      box.type = "checkbox";
      box.checked = DesmosOptions[key];
      
      box.name=key;
      box.id=key;
      formEl.appendChild(label);
      formEl.appendChild(box);
      formEl.appendChild(document.createElement("br"));
    }
    
    function persistState(){
      let options = getCalculatorOptions()[0];
      let	el = document.getElementById('calculator');
      let state = calculator.getState();
	  let formEl = document.getElementById('calculator_options');
      localStorage.setItem('calculator',JSON.stringify(state));
      
      let bounds = calculator.graphpaperBounds.mathCoordinates;
      let mathbounds = {left:bounds.left,right:bounds.right,top:bounds.top,bottom:bounds.bottom};
      
      let style = `width:${el.clientWidth}px;height:${el.clientHeight}px`
      result.innerHTML = String.raw`&lt;calculator options='${JSON.stringify(options)}' mathbounds='${JSON.stringify(mathbounds)}' style="${style}" data-string='${JSON.stringify(state)}' &gt;&lt;/calculator &gt;`
	  document.getElementById('text_result').innerHTML=String.raw`&lt;calculator options='${JSON.stringify(options)}' mathbounds='${JSON.stringify(mathbounds)}' style="${style}" data-string='${JSON.stringify(state)}' &gt;&lt;/calculator &gt;`;
    }
    
	let throttledSave;
    
    document.addEventListener("DOMContentLoaded", () => {
		
      let resultEl = document.getElementById('result');
      let formEl = document.getElementById('calculator_options');
      for(key in DesmosOptions){
        insertCheckbox(formEl,key,DesmosOptions[key]);
      }
      let calcDim= document.getElementById('calculator_dimensions');
		
      let	el = document.getElementById('calculator');
      calculator = Desmos.GraphingCalculator(el);
      let b = document.getElementById("copy")

      /******Functions depending on other JS files******/
      throttledSave = throttle(
        function()
        {
          persistState();
        },1000,{leading:false}
    	);

      /******Events******/
      calculator.observeEvent('change',function(){
        throttledSave();
      });
      formEl.addEventListener('change',function(){
		rebuildCalculator();
        throttledSave();
      });
      calcDim.addEventListener('change',rebuildCalculator);
      b.addEventListener("mouseup",function(){
        let copyEl = document.getElementById("result");
        copyToClipboard(copyEl);
      });
    });
  </script>
</html>
